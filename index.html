<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Bilbaobizi Monitor</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
	<style>
		body {
			background-color: #f8f9fa;
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			display: flex;
			justify-content: center;
			align-items: center;
			min-height: 100vh;
			margin: 0;
			padding: 10px;
		}

		.container {
			display: flex;
			justify-content: center;
			align-items: center;
			width: 100%;
			padding: 0;
		}

		.station-card {
			border-radius: 12px;
			box-shadow: 0 8px 12px rgba(0, 0, 0, 0.1);
			overflow: hidden;
			transition: transform 0.3s;
			background: linear-gradient(145deg, #2b6cb0, #38b2ac);
			color: white;
			position: relative;
			padding: 1.5rem 1rem !important;
			width: 100%;
			max-width: 500px;
			margin: 0 auto;
		}

		.station-card:hover {
			transform: translateY(-5px);
			box-shadow: 0 15px 20px rgba(0, 0, 0, 0.15);
		}

		.bike-icon {
			font-size: 1.8rem;
			margin-bottom: 5px;
			color: rgba(255, 255, 255, 0.9);
		}

		.station-name {
			font-size: 1.4rem;
			font-weight: 700;
			margin-bottom: 10px;
			text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
			letter-spacing: 0.5px;
		}

		.progress {
			height: 20px;
			margin: 12px 0;
			background-color: rgba(255, 255, 255, 0.2);
			border-radius: 12px;
			overflow: hidden;
		}

		.progress-bar {
			background-color: #27ae60;
			font-weight: bold;
			transition: width 1s ease-in-out;
			text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
			font-size: 0.9rem;
		}

		.stats-container {
			padding: 12px;
			background-color: rgba(255, 255, 255, 0.1);
			border-radius: 10px;
			margin-top: 15px;
			backdrop-filter: blur(5px);
		}

		.stats-item {
			margin-bottom: 8px;
			font-size: 1rem;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}

		.stats-item strong {
			font-weight: 600;
		}

		.stats-value {
			font-weight: bold;
			background-color: rgba(255, 255, 255, 0.15);
			padding: 4px 12px;
			border-radius: 30px;
		}

		.station-timer-container {
			position: absolute;
			top: 15px;
			right: 15px;
			z-index: 10;
			pointer-events: none;
		}

		 /* Add styles for the logo container */
		.station-logo-container {
			position: absolute;
			top: 15px;
			left: 15px;
			z-index: 10;
			width: 30px;
			height: 30px;
		}

		.station-logo {
			width: 100%;
			height: 100%;
			object-fit: contain;
			display: block;
		}

		.station-timer {
			animation: pulse 1s infinite alternate;
			display: block;
		}

		@keyframes pulse {
			from {
				opacity: 0.7;
			}

			to {
				opacity: 1;
			}
		}

		.bike-type {
			display: inline-block;
			padding: 4px 10px;
			border-radius: 30px;
			font-size: 0.85rem;
			margin-right: 5px;
			margin-bottom: 5px;
			background-color: rgba(255, 255, 255, 0.2);
			box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
		}

		@media (max-width: 576px) {
			.station-card {
				padding: 1.2rem 0.8rem !important;
				max-width: 95%;
			}

			.station-name {
				font-size: 1.2rem;
				margin-bottom: 8px;
			}

			.bike-icon {
				font-size: 1.5rem;
			}

			.stats-item {
				font-size: 0.9rem;
			}

			.stats-value {
				padding: 3px 8px;
			}

			.bike-type {
				font-size: 0.75rem;
				padding: 3px 8px;
				margin-right: 3px;
				margin-bottom: 3px;
			}
		}

		@media (max-width: 400px) {
			.col-md-6 {
				width: 100%;
			}
		}
	</style>
</head>

<body>
	<div class="container">
		<div id="station-container" class="row justify-content-center align-items-center w-100">
			<div class="col-12 col-md-10 col-lg-6">
				<div id="station-card" class="station-card p-4 animate__animated animate__fadeIn">
					<!-- Add the logo container -->
					<div class="station-logo-container">
						<img src="./bilbaobizi-logo.png" alt="Bilbaobizi Logo" class="station-logo">
					</div>
					
					<div class="station-timer-container">
						<svg class="station-timer" width="30" height="30" viewBox="0 0 30 30">
							<circle cx="15" cy="15" r="12" fill="none" stroke="#e0e0e0" stroke-width="2"></circle>
							<circle id="station-timer-progress" cx="15" cy="15" r="12" fill="none" stroke="#3498db"
								stroke-width="2" stroke-dasharray="75" stroke-dashoffset="0"
								transform="rotate(-90 15 15)"></circle>
						</svg>
					</div>

					<div class="bike-icon text-center">
						<i class="fas fa-bicycle"></i>
					</div>
					<h2 id="station-name" class="station-name text-center">Nombre de la Estación</h2>

					<div class="progress">
						<div id="bike-progress" class="progress-bar" role="progressbar" aria-valuenow="0"
							aria-valuemin="0" aria-valuemax="100"></div>
					</div>

					<div class="stats-container">
						<div class="row">
							<div class="col-md-6">
								<div class="stats-item">
									<strong>Bicicletas disponibles:</strong>
									<span id="bikes-available" class="stats-value">0</span>
								</div>
								<div class="stats-item">
									<strong>Espacios disponibles:</strong>
									<span id="space-status" class="stats-value">0/0</span>
								</div>
							</div>
							<div class="col-md-6">
								<div class="stats-item">
									<strong>Tipos de bicicletas:</strong>
								</div>
								<div id="bike-types"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
	<script>
		// Variables globales
		let stations = [];
		let currentStationIndex = 0;
		let updateInterval;
		let stationInterval;
		let stationTimerInterval;
		let stationTimeLeft = 15; // 15 segundos para cambio de estación

		// Función principal que inicia todo
		document.addEventListener('DOMContentLoaded', function () {
			// Recuperar la última estación visitada del localStorage
			const savedIndex = localStorage.getItem('currentStationIndex');
			if (savedIndex !== null) {
				currentStationIndex = parseInt(savedIndex);
			}

			fetchStationData();
		});

		// Función para obtener los datos de las estaciones
		function fetchStationData() {
			// Fetch XML data from the provided URL
			fetch('https://iframe.nextbike.net/maps/nextbike-live.xml?&city=532&domains=bo')
				.then(response => response.text())
				.then(str => new window.DOMParser().parseFromString(str, "text/xml"))
				.then(data => {
					// Procesar los datos XML
					processStationData(data);

					// Mostrar la estación actual o la primera si es inicial
					if (currentStationIndex >= stations.length) {
						currentStationIndex = 0;
					}
					showStation(currentStationIndex);

					// Configurar el cambio automático de estación
					if (stationInterval) clearInterval(stationInterval);
					stationInterval = setInterval(() => {
						currentStationIndex = (currentStationIndex + 1) % stations.length;
						showStation(currentStationIndex);
						resetStationTimer();
						// Guardar la estación actual en localStorage
						localStorage.setItem('currentStationIndex', currentStationIndex);
					}, 15000); // Cambiar cada 15 segundos

					// Iniciar el temporizador visual de la estación
					resetStationTimer();

					// Configurar la actualización periódica de datos
					if (updateInterval) clearInterval(updateInterval);
					updateInterval = setInterval(fetchStationData, 300000); // 5 minutos
				})
				.catch(error => {
					console.error('Error al obtener datos de las estaciones:', error);
				});
		}

		// Procesar los datos XML de las estaciones
		function processStationData(xmlData) {
			stations = [];
			const places = xmlData.querySelectorAll('place');

			places.forEach(place => {
				// Extraer información de la estación
				const bikes = parseInt(place.getAttribute('bikes') || 0);
				const bikeRacks = parseInt(place.getAttribute('bike_racks') || 0);
				const freeRacks = parseInt(place.getAttribute('free_racks') || 0);

				// Procesar los tipos de bicicletas (viene como JSON en string)
				let bikeTypes = {};
				try {
					const bikeTypesStr = place.getAttribute('bike_types');
					if (bikeTypesStr) {
						// Convertir el formato "{\\\"120\\\":1,\\\"194\\\":4,\\\"204\\\":1}" a objeto
						const cleanStr = bikeTypesStr.replace(/\\/g, '').replace(/"/g, '"');
						bikeTypes = JSON.parse(cleanStr.replace(/'/g, '"'));
					}
				} catch (error) {
					console.error('Error al procesar tipos de bicicletas:', error);
				}

				// Crear objeto de estación
				const station = {
					uid: place.getAttribute('uid'),
					name: place.getAttribute('name'),
					bikes: bikes,
					bikeRacks: bikeRacks,
					freeRacks: freeRacks,
					bikeTypes: bikeTypes,
					latitude: place.getAttribute('lat'),
					longitude: place.getAttribute('lng')
				};

				stations.push(station);
			});
		}

		// Mostrar datos de una estación
		function showStation(index) {
			const station = stations[index];
			if (!station) return;

			// Elementos de la UI
			const stationCard = document.getElementById('station-card');
			const stationName = document.getElementById('station-name');
			const bikesAvailable = document.getElementById('bikes-available');
			const spaceStatus = document.getElementById('space-status');
			const bikeProgress = document.getElementById('bike-progress');
			const bikeTypes = document.getElementById('bike-types');

			// Aplicar animación
			stationCard.classList.remove('animate__fadeIn');
			void stationCard.offsetWidth; // Truco para reiniciar la animación
			stationCard.classList.add('animate__fadeIn');

			// Actualizar información
			stationName.textContent = station.name;
			bikesAvailable.textContent = station.bikes;

			// Nuevo formato para espacios: "disponibles/total"
			spaceStatus.textContent = `${station.freeRacks}/${station.bikeRacks}`;

			// Calcular porcentaje de bicicletas disponibles
			const occupancyPercentage = Math.round((station.bikes / station.bikeRacks) * 100) || 0;

			// Actualizar barra de progreso con animación
			setTimeout(() => {
				bikeProgress.style.width = `${occupancyPercentage}%`;
				bikeProgress.textContent = `${occupancyPercentage}%`;

				// Cambiar color según disponibilidad
				if (occupancyPercentage < 20) {
					bikeProgress.classList.remove('bg-success', 'bg-warning');
					bikeProgress.classList.add('bg-danger');
				} else if (occupancyPercentage < 50) {
					bikeProgress.classList.remove('bg-success', 'bg-danger');
					bikeProgress.classList.add('bg-warning');
				} else {
					bikeProgress.classList.remove('bg-warning', 'bg-danger');
					bikeProgress.classList.add('bg-success');
				}
			}, 200);

			// Mostrar tipos de bicicletas
			bikeTypes.innerHTML = '';
			if (station.bikeTypes) {
				Object.entries(station.bikeTypes).forEach(([type, count]) => {
					bikeTypes.innerHTML += `
                        <span class="bike-type">Tipo ${type}: ${count}</span>
                    `;
				});
			}
		}

		// Nueva función: Gestionar el temporizador visual para el cambio de estación
		function resetStationTimer() {
			stationTimeLeft = 15; // 15 segundos
			if (stationTimerInterval) clearInterval(stationTimerInterval);

			updateStationTimerDisplay();

			stationTimerInterval = setInterval(() => {
				stationTimeLeft--;
				updateStationTimerDisplay();

				if (stationTimeLeft <= 0) {
					clearInterval(stationTimerInterval);
				}
			}, 1000);
		}

		// Nueva función: Actualizar el círculo de progreso del temporizador de estación
		function updateStationTimerDisplay() {
			const circle = document.getElementById('station-timer-progress');
			if (!circle) return;

			// El círculo completo tiene un valor de circunferencia de aproximadamente 75.4 (2*PI*r)
			// Calculamos qué porcentaje del círculo debe ser visible
			const circumference = 2 * Math.PI * 12;
			const offset = circumference * (1 - stationTimeLeft / 15); // Ajustado a 15 segundos

			// Actualizar el círculo
			circle.style.strokeDashoffset = offset;

			// Cambiar el color cuando queden pocos segundos
			if (stationTimeLeft < 5) {
				circle.style.stroke = "#e74c3c"; // rojo
			} else if (stationTimeLeft < 7) { // Ajustado de 10 a 7 (casi mitad de 15)
				circle.style.stroke = "#f39c12"; // naranja
			} else {
				circle.style.stroke = "#3498db"; // azul
			}
		}
	</script>
</body>

</html>